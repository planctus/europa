<?php
/**
 * @file
 * dt_social_media_sharing.module
 */

/**
 * Implements hook_preprocess_HOOK().
 *
 * This will add the required code to the header so that the webtools social
 * select is always loaded.
 */
function dt_social_media_sharing_preprocess_page(&$variables) {
  if (!path_is_admin(current_path())) {
    drupal_add_js(variable_get('dt_social_media_sharing_js_url', '//europa.eu/webtools/load.js'), 'external');
    drupal_add_html_head([
      '#tag' => 'script',
      '#value' => '{
        "service" : "sbkm",
        "popup" : false,
        "selection": true
      }',
      '#attributes' => [
        'type' => 'application/json',
      ],
    ], 'social_media_select');
  }
}

/**
 * Implements hook_block_info().
 */
function dt_social_media_sharing_block_info() {
  $blocks = [];
  $blocks['social_media_sharing']['info'] = t('Social Media Sharing');
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function dt_social_media_sharing_block_configure($delta = '') {
  $form = [];
  switch ($delta) {
    case 'social_media_sharing':
      // Text field form element.
      $form['dt_social_media_sharing_json_code'] = [
        '#type' => 'textarea',
        '#title' => t('Insert webtools object'),
        '#description' => t('Copy paste Webtools - Social Bookmark code'),
        '#default_value' => variable_get('dt_social_media_sharing_json_code', _dt_social_media_sharing_default_json()),
        '#wysiwyg' => FALSE,
        '#weight' => 0,
      ];

      $form['dt_social_media_sharing_js_url'] = [
        '#type' => 'textfield',
        '#title' => t('External Web Tools Url'),
        '#default_value' => variable_get('dt_social_media_sharing_js_url', '//europa.eu/webtools/load.js'),
        '#description' => t('This is required in order for it to work.'),
        '#required' => TRUE,
        '#weight' => 1,
      ];

      $form['dt_social_media_sharing_block_type'] = [
        '#type' => 'select',
        '#title' => t('Select which type of block do you need'),
        '#options' => [
          'vertical' => t('vertical'),
          'horizontal' => t('horizontal'),
        ],
        '#default_value' => variable_get('dt_social_media_sharing_block_type', FALSE),
        '#required' => FALSE,
        '#weight' => 2,
      ];

      break;
  }

  return $form;
}

/**
 * Implements hook_block_save().
 */
function dt_social_media_sharing_block_save($delta = '', $edit = []) {
  switch ($delta) {
    case 'social_media_sharing':
      if ($edit['dt_social_media_sharing_json_code'] && (!empty($edit['dt_social_media_sharing_json_code']))) {
        variable_set('dt_social_media_sharing_json_code', $edit['dt_social_media_sharing_json_code']);
      }
      variable_set('dt_social_media_sharing_js_url', $edit['dt_social_media_sharing_js_url']);
      variable_set('dt_social_media_sharing_block_type', $edit['dt_social_media_sharing_block_type']);
      break;
  }
}

/**
 * Implements hook_block_view().
 */
function dt_social_media_sharing_block_view($delta = '') {
  $block = [];
  switch ($delta) {
    case 'social_media_sharing':
      drupal_add_js(variable_get('dt_social_media_sharing_js_url', '//europa.eu/webtools/load.js'), 'external');
      $block['content'] = _dt_social_media_sharing_view_helper();
      break;
  }
  return $block;
}

/**
 * Generate the content of the social media sharing block.
 */
function _dt_social_media_sharing_view_helper() {
  $type = variable_get('dt_social_media_sharing_block_type');
  $modifier = $type ? ' social-media-links--webtool-' . $type : FALSE;
  $text = '<div class="social-media-links' . $modifier . '">';
  $text .= '<span class="social-media-links__label">' . t('Share this page') . ':</span>';
  $text .= variable_get('dt_social_media_sharing_json_code', _dt_social_media_sharing_default_json());
  $text .= '</div>';

  return $text;
}

/**
 * Helper function that holds default web tools SocialBookmarks JSON.
 *
 * @return string
 *   Creates and returns default json object.
 */
function _dt_social_media_sharing_default_json() {
  return '<script type="application/json">
  {
    "service": "sbkm",
    "popup": false,
    "sharing": true,
    "to": [
      "more",
      "twitter",
      "facebook",
      "googleplus",
      "linkedin",
      "e-mail"
    ],
    "stats": true,
    "css": {
      "list": "wtShareList social-media-links"
    }
  }
</script>';
}

/**
 * Implements hook_ds_fields_info().
 *
 * SocialMedia Bookmark field from Web tools,
 * this field will be used by several content types
 * and possible in both Info + Pol websites.
 */
function dt_social_media_sharing_ds_fields_info($entity_type) {
  $ds_fields = [];

  $ds_fields['social_bookmark_webtools'] = [
    'title' => t('Social Bookmark Webtools'),
    'field_type' => DS_FIELD_TYPE_BLOCK,
    'properties' => [
      'block' => 'dt_social_media_sharing|social_media_sharing',
      'block_render' => '1',
    ],
    'ui_limit' => '',
    'entities' => [
      'node' => 'node',
    ],
  ];

  return ['node' => $ds_fields];
}
