<?php
/**
 * @file
 * Nexteuropa Legacy link
 */

/**
 * Implements hook_entity_load().
 */
function nexteuropa_legacy_link_entity_load($entities, $type) {
  foreach ($entities as $entity) {
    if ($legacy = _nexteuropa_legacy_link_add_legacy($entity, $type)) {
      $entity->legacy = $legacy;
    }
  }
}

/**
 * Implements hook_node_view().
 */
function nexteuropa_legacy_link_taxonomy_term_view($term, $view_mode, $langcode) {
  // Extend node object with Legacy link if it exists.
  $term = _nexteuropa_legacy_link_add_legacy($term, 'taxonomy_term');
}

/**
 * Implements hook_field_attach_view_alter().
 */
function nexteuropa_legacy_link_field_attach_view_alter(&$output, $context) {
  foreach (element_children($output) as $field_name) {
    $element = &$output[$field_name];
    // Fix linked entity references to link to Legacy link and not to entity.
    if ($element['#field_type'] == 'entityreference' || $element['#field_type'] == 'taxonomy_term_reference') {
      $field = field_info_field($field_name);
      $instance = field_info_instance($element['#entity_type'], $field_name, $element['#bundle']);
      $display = field_get_display($instance, $context['view_mode'], $element['#object']);

      if ($element['#field_type'] == 'entityreference') {
        // Skip entity reference fields not targeting nodes.
        if (
          !isset($display['settings']['link']) ||
          !isset($field['settings']['target_type']) ||
          $field['settings']['target_type'] !== 'node' ||
          $field['settings']['target_type'] !== 'taxonomy_term'
        ) {
          continue;
        }

        foreach ($element['#items'] as $delta => $item) {
          // Check if item has Legacy link.
          $target = _nexteuropa_legacy_link_add_legacy($item['entity'], $field['settings']['target_type']);
          if (isset($item['entity']->legacy)) {
            $element[$delta] = array('#markup' => l($item['entity']->title, $item['entity']->legacy));
          }
        }
      }
      // Taxonomy term reference.
      else {
        $excluded_fromatters = array('taxonomy_term_reference_plain', 'taxonomy_term_reference_rss_category');
        if (in_array($display['type'], $excluded_fromatters)) {
          continue;
        }

        foreach ($element['#items'] as $delta => $item) {
          // Check if item has Legacy link.
          if (isset($term->legacy)) {
            $element[$delta] = array('#markup' => l($term->name, $term->legacy));
          }
        }
      }
    }
  }
}

/**
 * Adds Legacy link to node path array where applicable.
 */
function _nexteuropa_legacy_link_add_legacy($entity, $entity_type) {
  // If Legacy link field is used add it to path array.
  $wrapper = entity_metadata_wrapper($entity_type, $entity);
  if ($wrapper->__isset('field_core_legacy_link')) {
    $legacy_link = $wrapper->field_core_legacy_link->value();

    return !empty($legacy_link) ? $legacy_link['url'] : FALSE;
  }

  return FALSE;
}
